(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{217:function(t,a,s){"use strict";s.r(a);var n=s(6),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h3",{attrs:{id:"背景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[t._v("#")]),t._v(" 背景")]),t._v(" "),s("p",[t._v("面试常常会被问到，setState到底是同步还是异步的？")]),t._v(" "),s("hr"),t._v(" "),s("h3",{attrs:{id:"答案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#答案"}},[t._v("#")]),t._v(" 答案")]),t._v(" "),s("ol",[s("li",[t._v("在legacy模式中，命中了"),s("code",[t._v("batchedUpdates")]),t._v("时是异步，未命中"),s("code",[t._v("batchedUpdates")]),t._v("时是同步")]),t._v(" "),s("li",[t._v("concurrent模式中，都是异步的")])]),t._v(" "),s("hr"),t._v(" "),s("h3",{attrs:{id:"react的模式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#react的模式"}},[t._v("#")]),t._v(" React的模式")]),t._v(" "),s("p",[t._v("我们可以从"),s("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/concurrent-mode-adoption.html#why-so-many-modes",target:"_blank",rel:"noopener noreferrer"}},[t._v("React官网"),s("OutboundLink")],1),t._v("看到关于React模式的解释：")]),t._v(" "),s("blockquote",[s("ul",[s("li",[t._v("legacy模式：通过"),s("code",[t._v("ReactDOM.render(<App/>,rootNode)")]),t._v("创建的应用。这是当前React app使用的方式")]),t._v(" "),s("li",[t._v("blocking模式："),s("code",[t._v("ReactDOM.createBlockingRoot(rootNode).render(<App />)")]),t._v("创建的应用属于blocking模式，目前正在实验中，作为迁移到concurrent模式的第一个步骤")]),t._v(" "),s("li",[t._v("concurrent模式："),s("code",[t._v("ReactDOM.createRoot(rootNode).render(<App />)")]),t._v("，目前正在实验中，未来稳定之后，打算作为React默认的开发模式，更新是有优先级并且可以打断的")])])]),t._v(" "),s("p",[t._v("简单来说，React这么多模式，是基于渐进的迁移策略考虑，未来concureent模式将会是默认模式。")]),t._v(" "),s("p",[t._v("但是当前大多数app应用都是legacy模式，无法直接迁移到concurrent模式，强制迁移会出现很多无法修复的错误。\nblocking模式作为concurrent模式的降级版本。")]),t._v(" "),s("p",[t._v("从长远来看，模式的数量是会收敛，我们无需考虑不同的模式")]),t._v(" "),s("hr"),t._v(" "),s("h3",{attrs:{id:"legacy模式-目前大多数react应用的模式下-setstate的表现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#legacy模式-目前大多数react应用的模式下-setstate的表现"}},[t._v("#")]),t._v(" legacy模式-目前大多数React应用的模式下 setState的表现")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LegacySetState")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("React"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Component")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("super")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("props"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n         num"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" \n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n   "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("updateNum")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      \n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 方式1-------------------")]),t._v("\n      console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"before setState "')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("num"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" \n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("num"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("num"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" \n      console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"after setState "')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("num"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" \n\n     "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 方式2-------------------")]),t._v("\n     "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// setTimeout(()=>{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// this.setState({num: this.state.num+1}) ")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// console.log("after setState ",num) ')]),t._v("\n     "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// },0)")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n     "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" num "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n     console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Class render "')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("num"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  \n     "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("p onClick"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("updateNum"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("click me "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("num"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("p"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("  \n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"结果"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#结果"}},[t._v("#")]),t._v(" 结果")]),t._v(" "),s("p",[t._v("方式一：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/superwtt/MyFileRepository/main/image/React/1-1.png",alt:""}})]),t._v(" "),s("p",[t._v("方式二：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/superwtt/MyFileRepository/main/image/React/1-2.png",alt:""}})]),t._v(" "),s("h4",{attrs:{id:"分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#分析"}},[t._v("#")]),t._v(" 分析")]),t._v(" "),s("ol",[s("li",[t._v("方式一的打印结果我们发现，setState是异步更新的")]),t._v(" "),s("li",[t._v("方式二的打印结果我们发现，setState是同步更新的")])]),t._v(" "),s("h4",{attrs:{id:"源码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#源码"}},[t._v("#")]),t._v(" 源码")]),t._v(" "),s("p",[t._v("源码目录："),s("code",[t._v("https://github.com/facebook/react/blob/17.0.1/packages/react-reconciler/src/ReactFiberWorkLoop.new.js")])]),t._v(" "),s("ol",[s("li",[t._v("方式一中，legacy模式下，setState的异步更新，是基于React源码中的性能优化特性："),s("code",[t._v("batchedUpdates")]),t._v("，即多个setState会被合并成一个更新，减少性能开销，假如一次setState就触发一个完整的更新流程，那么每一次setState的调用都会触发一次re-render，我们的视图很可能没刷几次就卡死了。")])]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" batchedUpdates"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("A")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("R")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("fn")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("A")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("R")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("A")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("R")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" prevExecutionContext "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" executionContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  executionContext "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|=")]),t._v(" BatchedContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将全局变量executionContext加上批量更新的flag")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fn")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("finally")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    executionContext "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" prevExecutionContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("executionContext "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" NoContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Flush the immediate callbacks that were scheduled during this batch")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("resetRenderTimer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("flushSyncCallbackQueue")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h5",{attrs:{id:"解析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#解析"}},[t._v("#")]),t._v(" 解析")]),t._v(" "),s("ol",[s("li",[t._v("首先"),s("code",[t._v("batchedUpdates")]),t._v("方法，会将一个全局变量"),s("code",[t._v("executionContext")]),t._v("打上"),s("code",[t._v("BatchedContext")]),t._v('批处理标签，进来先锁上，将这个变量变成true，标明当前"正处于批量更新流程中"。当被“锁上”时，任何需要更新的组件都只能暂时进入'),s("code",[t._v("dirtyComponents")]),t._v("里排队等候下一次批量更新")]),t._v(" "),s("li",[t._v("执行fn，fn指的就是这边的"),s("code",[t._v("updateNum")]),t._v("方法，执行完之后，将"),s("code",[t._v("BatchedContext")]),t._v("从"),s("code",[t._v("executionContext")]),t._v("中去除，执行完再放开")]),t._v(" "),s("li",[t._v("当我们执行"),s("code",[t._v("updateNum")]),t._v("这个方法时，包含了一个被打了批量更新标签的全局变量"),s("code",[t._v("executionContext")]),t._v("，React内部会判断，如果这次更新中，"),s("code",[t._v("executionContext")]),t._v("包含了"),s("code",[t._v("BatchedContext")]),t._v("，它就会认为这是一次批处理")]),t._v(" "),s("li",[t._v("批处理中触发的多次更新都会被合并成一个更新，并且异步执行")])]),t._v(" "),s("hr"),t._v(" "),s("h5",{attrs:{id:"如何跳出batchedupdates呢"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#如何跳出batchedupdates呢"}},[t._v("#")]),t._v(" 如何跳出batchedUpdates呢")]),t._v(" "),s("ol",[s("li",[t._v("如果我们触发的fn中"),s("code",[t._v("this.setState")]),t._v("这一步是异步执行的，那么等"),s("code",[t._v("this.setState")]),t._v("执行的时候，我们全局的"),s("code",[t._v("executionContext")]),t._v("已经不存在"),s("code",[t._v("BatchedContext")]),t._v("了。因为"),s("code",[t._v("batchedUpdates")]),t._v("在执行完fn之后会重置"),s("code",[t._v("executionContext")])]),t._v(" "),s("li",[t._v("所以我们只要将"),s("code",[t._v("this.setState")]),t._v("放到"),s("code",[t._v("setTimeout")]),t._v("中，将"),s("code",[t._v("this.setState")]),t._v("这个操作变成异步执行，此时全局的变量中已经不存在"),s("code",[t._v("BatchedContext")]),t._v("这个flag。因为这个标识对"),s("code",[t._v("setTimeout")]),t._v("里面的代码没有任何的管控能力")]),t._v(" "),s("li",[t._v("当不存在这个flag时，React源码中，有一个函数"),s("code",[t._v("scheduleUpdateOnFiber")]),t._v("，每次调度更新都会执行这个函数")])]),t._v(" "),s("ul",[s("li",[t._v("源码目录："),s("code",[t._v("https://github.com/facebook/react/blob/17.0.1/packages/react-reconciler/src/ReactFiberWorkLoop.old.js")])])]),t._v(" "),s("ol",{attrs:{start:"4"}},[s("li",[t._v("当上下文什么都没有的情况下，我们会同步的执行这次更新。当我们用"),s("code",[t._v("setTimeout")]),t._v("触发"),s("code",[t._v("this.setState")]),t._v("，就会进入"),s("code",[t._v("executionContext === NoContext")]),t._v("触发同步的更新")])]),t._v(" "),s("ul",[s("li",[t._v("我们用"),s("code",[t._v("ReactDOM.render")]),t._v("创建出来的应用叫做同步的优先级,要进入"),s("code",[t._v("if (executionContext === NoContext)")]),t._v("的前提是"),s("code",[t._v("if (lane === SyncLane)")]),t._v("，也就是说当前更新的优先级是同步的优先级")]),t._v(" "),s("li",[t._v("而用concurrent模式下的优先级是异步的优先级，即使"),s("code",[t._v("this.setState")]),t._v("被异步包裹了，状态的更新也是异步的")])]),t._v(" "),s("ol",{attrs:{start:"5"}},[s("li",[s("code",[t._v("setTimeout")]),t._v("、"),s("code",[t._v("setInterval")]),t._v("、直接在DOM上绑定原生事件，都不会进入React的这个调度流程，这种情况下都是同步的。但是同步也代表着DOM的同步更新，也就意味着如果你多次setState，会导致多次更新，这是毫无意义且浪费性能的")]),t._v(" "),s("li",[t._v("总结：这道题目对于不同模式下的应用答案是不一样的")])]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("scheduleUpdateOnFiber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//...")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("lane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" SyncLane"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n         "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ....")]),t._v("\n         "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("executionContext "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" NoContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Flush the synchronous work now, unless we're already working or inside")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// a batch. This is intentionally inside scheduleUpdateOnFiber instead of")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// scheduleCallbackForFiber to preserve the ability to schedule a callback")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// without immediately flushing it. We only do this for user-initiated")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// updates, to preserve historical behavior of legacy mode.")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("resetRenderTimer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("flushSyncCallbackQueue")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),s("hr"),t._v(" "),s("h5",{attrs:{id:"如何获取最新的state呢"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#如何获取最新的state呢"}},[t._v("#")]),t._v(" 如何获取最新的state呢")]),t._v(" "),s("ol",[s("li",[t._v("回调函数callback")])]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  val"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("val"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("val"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[t._v("componentDidUpdate")])]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("componentUpdate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("val"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("ol",{attrs:{start:"3"}},[s("li",[t._v("将"),s("code",[t._v("setState")]),t._v("放在"),s("code",[t._v("setTimeout")]),t._v("中")])]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" that "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  that"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("val"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("that"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("val"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("that"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("val"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("hr"),t._v(" "),s("h3",{attrs:{id:"什么是合成事件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#什么是合成事件"}},[t._v("#")]),t._v(" 什么是合成事件")]),t._v(" "),s("ol",[s("li",[t._v("定义：React为了解决跨平台、兼容性问题，自己封装了一套事件机制，代理了原生事件。在JSX中，常见的"),s("code",[t._v("onClick")]),t._v("、"),s("code",[t._v("onChange")]),t._v("都是合成事件")]),t._v(" "),s("li",[t._v("目的：")])]),t._v(" "),s("ul",[s("li",[t._v("进行浏览器兼容，实现更好的跨平台")])]),t._v(" "),s("ol",{attrs:{start:"3"}},[s("li",[t._v("与原生事件的区别")])]),t._v(" "),s("h4",{attrs:{id:"参考链接"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[t._v("#")]),t._v(" 参考链接")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://mp.weixin.qq.com/s/my2Jx7pcbVYnaCWklAzKXA",target:"_blank",rel:"noopener noreferrer"}},[t._v("Good"),s("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=e.exports}}]);