### React中的生命周期有哪些
1. 定义：生命周期是指在某一时刻，组件会自动调用执行的函数
2. 组件的执行时期：
+ 挂载阶段mount：只有组件在第一次被挂载在页面的时候执行
  + `constructor`：初始化state对象，给自定义方法绑定this
  + ~~`componentWillMount`~~：组件即将被挂载到页面的时候执行，在`render`之前，还没有挂载DOM
  + `componentDidMount`：组件被挂载到页面之后执行，在`render`之后，已经挂载DOM

+ 更新阶段update：组件更新的时候执行
  + `shouldComponentUpdate`：组件更新之前执行，需要返回true/false，返回true表示需要更新组件，返回false表示不需要更新组件
  + ~~`componentWillUpdate`~~：组件更新之前执行，在`shouldComponentUpdate`之后执行，且`shouldComponentUpdate`返回true才执行，否则不执行
  + `render`
  + `getSnapshotBeforeUpdate`：在render之后，componentDidUpdate之前调用
  + `componentDidUpdate`：组件更新完成之后执行
  + ~~`componentWillReceiveProps`~~：当一个组件从父组件接收了参数，只要这个父组件的render函数被重新执行了，这个生命周期才执行


+ 卸载阶段unmount
  + `componentWillUnmount`：当这个组件即将从页面中剔除的时候执行

![](https://raw.githubusercontent.com/superwtt/MyFileRepository/main/image/React/生命周期.png)

---

### 执行次数
1. 只执行一次：`constructor`、`componentWillMount`、`componentDidMount`
2. 执行多次：`render`、子组件的`componentWillReceiveProps`、`componentWillUpdate`、`componentDidUpdate`
3. 有条件的执行：`componentWillUmmount`组件离开时才执行
4. 不执行的：根组件的`componentWillReceiveProps`，因为根组件没有父组件传值给根组件了

---

### 源码解析
源码目录：`react/packages/react-dom/src/client/ReactDOM.js`
源码目录：`react/packages/react-reconciler/src/ReactFiberClassComponent.js`
查看每个生命周期的调用时机

从`ReactDOM.render(<App />, document.getElementById("root"))`开始

ReactDOM.render渲染组件 -> 经过babel编译后变成React.createElement -> 转为React Element，如何将这些React Element插入到DOM中的呢？

```javascript
const ReactDOM: Object = {
  // ...
  render(
    element: React$Element<any>,
    container: DOMContainer,
    callback: ?Function,
  ) {
    return legacyRenderSubtreeIntoContainer(
      null,
      element,
      container,
      false,
      callback,
    );
}

// 1.0 调用legacyRenderSubtreeIntoContainer，初始化container
function legacyRenderSubtreeIntoContainer(
  parentComponent: ?React$Component<any, any>,
  children: ReactNodeList,
  container: DOMContainer,
  forceHydrate: boolean,
  callback: ?Function,
) {
  
  let root: Root = (container._reactRootContainer: any);
  if (!root) {
    // Initial mount
    root = container._reactRootContainer = legacyCreateRootFromDOMContainer(
      container,
      forceHydrate,
    );
    // Initial mount should not be batched.
    unbatchedUpdates(() => {
      if (parentComponent != null) {
        root.legacy_renderSubtreeIntoContainer(
          parentComponent,
          children,
          callback,
        );
      } else {
        root.render(children, callback);
      }
    });
  } else {
    // Update
    if (parentComponent != null) {
      root.legacy_renderSubtreeIntoContainer(
        parentComponent,
        children,
        callback,
      );
    } else {
      root.render(children, callback);
    }
  }
  return getPublicRootInstance(root._internalRoot);
}

// 2.1 首次渲染的时候 进入root.render
ReactRoot.prototype.render = function(
  children: ReactNodeList,
  callback: ?() => mixed,
): Work {
  const root = this._internalRoot;
  const work = new ReactWork();
  callback = callback === undefined ? null : callback;
  if (callback !== null) {
    work.then(callback);
  }
  updateContainer(children, root, null, work._onCommit);
  return work;
};
// 进入updateContainer发现调用的是updateContainerAtExpirationTime
export function updateContainerAtExpirationTime(
  element: ReactNodeList,
  container: OpaqueRoot,
  parentComponent: ?React$Component<any, any>,
  expirationTime: ExpirationTime,
  callback: ?Function,
) {
  // TODO: If this is a nested container, this won't be the root.
  const current = container.current;
  const context = getContextForSubtree(parentComponent);
  if (container.context === null) {
    container.context = context;
  } else {
    container.pendingContext = context;
  }

  return scheduleRootUpdate(current, element, expirationTime, callback);
}
```


---

### 废弃的以及新增的生命周期
1.废弃的
+ `componentWillMount`
+ `componentWillReceiveProps`
+ `componentWillUpdate`


2.新增的
+ `static getDerivedStateFromProps`：当我们接收到新的属性想去修改我们的state，可以在这个生命周期中完成
+ `getSnapshotBeforeUpdate`

---

### 异步渲染的两个阶段
1.`Reconciliation阶段`
+ `componentWillMount`
+ `componentWillReceiveProps`
+ `shouldComponentUpdate`
+ `componentWillUpdate`

2.`Commit`阶段
+ `componentDidMount`
+ `componentDidUpdate`
+ `componentWillUnMount`

---

https://developer.aliyun.com/article/72330
